#!/bin/bash
#
# Git pre-commit hook for auto-version bumping
# When a SKILL.md file is staged, automatically bumps the patch version
# in all 3 locations (SKILL.md, plugin.json, marketplace.json)
#

REPO_ROOT=$(git rev-parse --show-toplevel)

# Find staged SKILL.md files (only in plugins directory)
staged_skills=$(git diff --cached --name-only | grep '^plugins/.*/skills/.*/SKILL\.md$')

if [ -z "$staged_skills" ]; then
    # No SKILL.md files staged, nothing to do
    exit 0
fi

# Process each staged SKILL.md
for skill_path in $staged_skills; do
    # Extract plugin name from path (plugins/{plugin-name}/skills/...)
    plugin_name=$(echo "$skill_path" | cut -d'/' -f2)

    echo "Auto-bumping version for plugin: $plugin_name"

    # Run the bump script
    if ! python3 "$REPO_ROOT/scripts/bump-version.py" "$plugin_name"; then
        echo "Error: Version bump failed for $plugin_name"
        exit 1
    fi

    # Re-stage the modified files
    git add "$REPO_ROOT/$skill_path"
    git add "$REPO_ROOT/plugins/$plugin_name/.claude-plugin/plugin.json"
    git add "$REPO_ROOT/.claude-plugin/marketplace.json"
done

echo "Version bump complete."
