"""API client for {API_NAME}."""

import httpx
from typing import Optional

from .config import API_KEY, API_BASE_URL


class APIError(Exception):
    """API error with status code and retry information."""

    def __init__(self, message: str, status_code: int = None, retryable: bool = False):
        self.status_code = status_code
        self.retryable = retryable
        super().__init__(message)


class {CLIENT_CLASS}:
    """Client for {API_NAME}."""

    def __init__(self):
        self.base_url = API_BASE_URL
        self.headers = {
            "Authorization": f"Bearer {API_KEY}",
            "Content-Type": "application/json",
        }

    def _handle_response(self, response: httpx.Response) -> dict:
        """Handle API response with appropriate error messages."""
        if response.status_code == 401:
            raise APIError(
                "Invalid API key. Check {API_KEY_VAR} environment variable.",
                401,
            )
        if response.status_code == 402:
            raise APIError("API quota exceeded. Check your plan.", 402)
        if response.status_code == 403:
            raise APIError("Permission denied for this operation.", 403)
        if response.status_code == 429:
            raise APIError("Rate limited. Try again later.", 429, retryable=True)
        if response.status_code >= 500:
            raise APIError(
                f"Server error ({response.status_code}). Try again later.",
                response.status_code,
                retryable=True,
            )
        response.raise_for_status()
        return response.json()

    def search(self, query: str, limit: int = 10) -> dict:
        """Search the API.

        Args:
            query: Search query
            limit: Maximum results

        Returns:
            Search results
        """
        with httpx.Client() as client:
            response = client.get(
                f"{self.base_url}/search",
                headers=self.headers,
                params={"q": query, "limit": limit},
            )
            return self._handle_response(response)

    def list_items(self, category: Optional[str] = None) -> dict:
        """List items from the API.

        Args:
            category: Optional category filter

        Returns:
            List of items
        """
        params = {}
        if category:
            params["category"] = category

        with httpx.Client() as client:
            response = client.get(
                f"{self.base_url}/items",
                headers=self.headers,
                params=params,
            )
            return self._handle_response(response)


# Singleton client instance
_client: Optional[{CLIENT_CLASS}] = None


def get_client() -> {CLIENT_CLASS}:
    """Get or create the API client."""
    global _client
    if _client is None:
        _client = {CLIENT_CLASS}()
    return _client
